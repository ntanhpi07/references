using System;
using System.IO;
using System.Text;
using System.Collections.Generic;
using System.Linq;
using System.Threading.Tasks;
using System.DirectoryServices;
using System.DirectoryServices.AccountManagement;

namespace GetSomeADObjects
{
    class Program
    {
        static void Main(string[] args)
        {
            String strWorkingDirectory = Directory.GetCurrentDirectory();
            String strConfigurationFile = strWorkingDirectory + @"\ConfigurationDetails.txt";

            //Default Domain Controller
            String strDomain = "";
            String strRootSuffix = "";
            String strUserAccount = "";
            String strPassword = "";
            Console.WriteLine("Current Working Directory is [" + strWorkingDirectory + "]");

            // Read from the DomainController File to determine the DC to use
            try
            {   // Open the Group Tracker File and get 
                using (StreamReader sr = new StreamReader(strConfigurationFile))
                {
                    // Read the stream to a string, and write the string to the console.
                    strDomain = sr.ReadLine();
                    strRootSuffix = sr.ReadLine();
                    strUserAccount = sr.ReadLine();
                    strPassword = sr.ReadLine();

                    Console.WriteLine("Using DC [" + strDomain + "]");
                    Console.WriteLine("Using root suffix [" + strRootSuffix + "]");
                    Console.WriteLine("User Account [" + strUserAccount + "]");
                    Console.WriteLine("Using Password [XXXXXXXXX]");
                }
            }
            catch (Exception e)
            {
                Console.WriteLine("The Configuration File could not be found");
                throw (e);
            }

            String strParentDirectory = Directory.GetParent(Directory.GetCurrentDirectory()).ToString();

            String strUserObjectFile1 = strParentDirectory + @"\ADUsers\GetUsers1\UserInput.txt";
            String strUserObjectFile2 = strParentDirectory + @"\ADUsers\GetUsers2\UserInput.txt";
            String strUserObjectFile3 = strParentDirectory + @"\ADUsers\GetUsers3\UserInput.txt";
            String strUserObjectFile4 = strParentDirectory + @"\ADUsers\GetUsers4\UserInput.txt";
            String stGroupObjectFile1 = strParentDirectory + @"\ADUsers\GetAssignments1\GroupsInput.txt";
            String stGroupObjectFile2 = strParentDirectory + @"\ADUsers\GetAssignments2\GroupsInput.txt";
            String stGroupObjectFile3 = strParentDirectory + @"\ADUsers\GetAssignments3\GroupsInput.txt";
            String stGroupObjectFile4 = strParentDirectory + @"\ADUsers\GetAssignments4\GroupsInput.txt";

            File.Delete(strUserObjectFile1);  File.Delete(strUserObjectFile2);  File.Delete(strUserObjectFile3);  File.Delete(strUserObjectFile4);
            File.Delete(stGroupObjectFile1);  File.Delete(stGroupObjectFile2);  File.Delete(stGroupObjectFile3);  File.Delete(stGroupObjectFile4);

            String strUserTracker1 = strParentDirectory + @"\ADUsers\GetUsers1\UserTracker.txt";
            String strUserTracker2 = strParentDirectory + @"\ADUsers\GetUsers2\UserTracker.txt";
            String strUserTracker3 = strParentDirectory + @"\ADUsers\GetUsers3\UserTracker.txt";
            String strUserTracker4 = strParentDirectory + @"\ADUsers\GetUsers4\UserTracker.txt";
            String stGroupTracker1 = strParentDirectory + @"\ADUsers\GetAssignments1\GroupTracker.txt";
            String stGroupTracker2 = strParentDirectory + @"\ADUsers\GetAssignments2\GroupTracker.txt";
            String stGroupTracker3 = strParentDirectory + @"\ADUsers\GetAssignments3\GroupTracker.txt";
            String stGroupTracker4 = strParentDirectory + @"\ADUsers\GetAssignments4\GroupTracker.txt";

            File.Delete(strUserTracker1); File.Delete(strUserTracker2); File.Delete(strUserTracker3); File.Delete(strUserTracker4);
            File.Delete(stGroupTracker1); File.Delete(stGroupTracker2); File.Delete(stGroupTracker3); File.Delete(stGroupTracker4);


            // Connect to a Domain Controller
            PrincipalContext ctx = new PrincipalContext(ContextType.Domain,
                                            strDomain,
                                            strRootSuffix,
                                            ContextOptions.Negotiate);

            String strMessage = null;
           
            var searchUserPrinciple = new UserPrincipal(ctx);

            PrincipalSearcher srchUser = new PrincipalSearcher(searchUserPrinciple);
            var searchResults = srchUser.FindAll();
            int iCounter = 0;
            int iRouter = 0;
            String strAssignmentFile = String.Empty;

            foreach (UserPrincipal p in searchResults)
            {
                iCounter++;
                iRouter = iCounter % 4;

                strMessage = p.DistinguishedName + Environment.NewLine;

                switch (iRouter)
                {
                    case 0:
                        strAssignmentFile = strUserObjectFile1;
                        break;
                    case 1:
                        strAssignmentFile = strUserObjectFile2;
                        break;
                    case 2:
                        strAssignmentFile = strUserObjectFile3;
                        break;
                    case 3:
                        strAssignmentFile = strUserObjectFile4;
                        break;
                }


                // Write membership records to the GroupAssignments file
                if (!File.Exists(strAssignmentFile))
                    File.WriteAllText(strAssignmentFile, strMessage);
                else
                    File.AppendAllText(strAssignmentFile, strMessage);
            }

            srchUser.Dispose();
            
            var searchGroupPrinciple = new GroupPrincipal(ctx);
            PrincipalSearcher srchGroup = new PrincipalSearcher(searchGroupPrinciple);
            searchResults = srchGroup.FindAll();
            
            
            foreach (Principal p in searchResults)
            {
                iCounter++;
                iRouter = iCounter % 4;

                strMessage = p.DistinguishedName + Environment.NewLine;

                switch (iRouter)
                {
                    case 0:
                        strAssignmentFile = stGroupObjectFile1;
                        break;
                    case 1:
                        strAssignmentFile = stGroupObjectFile2;
                        break;
                    case 2:
                        strAssignmentFile = stGroupObjectFile3;
                        break;
                    case 3:
                        strAssignmentFile = stGroupObjectFile4;
                        break;
                }

                // Write membership records to the GroupAssignments file
                if (!File.Exists(strAssignmentFile))
                    File.WriteAllText(strAssignmentFile, strMessage);
                else
                    File.AppendAllText(strAssignmentFile, strMessage);
            }

            srchGroup.Dispose();
          
            ctx.Dispose();

        }
    }
}
